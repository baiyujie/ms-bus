{"version":3,"sources":["/vendor/ane-component/components/ms-upload/ms-upload.ts"],"names":[],"mappings":";;;AACA,oDAAqD;AACrD,0CAAkD;AAClD,GAAyB;AACzB,4BAA0B;AAC1B,4BAA0B;AAC1B,uCAAiC;AAEjC;;;;;;;;;;;GAWG;AACH,uBAAgB,CAAC,MAAM,CAAC;IACpB,WAAW,EAAE,WAAW;IACxB,QAAQ,EAAE,QAAQ,CAAC,kBAAkB,CAAC;IACtC,QAAQ,EAAE,SAAS;IACnB,QAAQ,EAAE;QACN,MAAM,EAAE,EAAE;QACV,OAAO,EAAE,EAAE;QACX,KAAK,EAAE,EAAE;QACT,QAAQ,EAAE,EAAE;QACZ,MAAM,EAAE,EAAE;QACV,QAAQ,EAAE,WAAW;QACrB,cAAc,EAAE,IAAI;QACpB,QAAQ,EAAE,iBAAiB;QAC3B,SAAS,EAAE,6CAA6C;QACxD,QAAQ,EAAE,oFAAoF;QAC9F,SAAS,EAAE,IAAI;QACf,YAAY;YACR,MAAM,CAAC,IAAI,CAAC;QAChB,CAAC;QACD,YAAY,YAAC,IAAI;YACb,IAAI,KAAK,CAAC;YACV,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,WAAC,IAAI,QAAC,CAAC,GAAG,KAAK,IAAI,CAAC,GAAG,EAAlB,CAAkB,CAAC,CAAC;YACjD,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YAC5B,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,IAAI,IAAI,CAAC,KAAK,IAAI,CAAC,EAAE,CAAC,CAAC;YAChD,IAAI,CAAC,YAAY,CAAC;gBACd,MAAM,EAAE,EAAE,KAAK,EAAE,IAAI,CAAC,cAAc,GAAG,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC,EAAE;gBACzD,IAAI,EAAE,aAAa;aACtB,CAAC,CAAC;QACP,CAAC;QACD,kBAAkB,YAAC,KAAK;YAAxB,iBAaC;YAZG,KAAK,CAAC,GAAG,CAAC,UAAC,GAAG,EAAE,CAAC;gBACb,EAAE,CAAC,CAAC,GAAG,KAAK,EAAE,CAAC,CAAC,CAAC;oBACb,MAAM,CAAC;gBACX,CAAC;gBACD,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;oBACf,GAAG,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;oBACb,IAAI,EAAE,GAAG,CAAC,OAAO,CAAC,iBAAiB,EAAE,IAAI,CAAC;oBAC1C,GAAG,EAAE,GAAG;oBACR,MAAM,EAAE,MAAM;oBACd,QAAQ,EAAE,CAAC;iBACd,CAAC,CAAC;YACP,CAAC,CAAC,CAAC;QACP,CAAC;QACD,MAAM,YAAC,KAAK;YAAZ,iBAcC;YAbG,sBAAc,CAAC,IAAI,CAAC,CAAC;YACrB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC;YACvB,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACpC,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,WAAC;gBAClB,IAAI,KAAK,GAAG,CAAC,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;gBAClC,KAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;gBACtB,KAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,CAAC;gBAC/B,KAAI,CAAC,YAAY,CAAC;oBACd,MAAM,EAAE,EAAE,KAAK,EAAE,KAAI,CAAC,cAAc,GAAG,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC,EAAE;oBACzD,YAAY,EAAE,IAAI;oBAClB,IAAI,EAAE,aAAa;iBACtB,CAAC,CAAC;YACP,CAAC,CAAC,CAAC;QACP,CAAC;QACD,OAAO,YAAC,KAAK;YAAb,iBAmEC;YAlEG,IAAI,CAAC,SAAS,GAAG,sBAAQ,CAAC,IAAI,CAAC;gBAC3B,GAAG,EAAE,IAAI,CAAC,MAAM;gBAChB,SAAS,EAAE,KAAK,CAAC,MAAM,CAAC,oBAAoB,CAAC,OAAO,CAAC,CAAC,IAAI;gBAC1D,MAAM,EAAE,UAAC,KAAK;oBACV,yBAAyB;oBACzB,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,cAAI,IAAI,QAAC,IAAI,CAAC,IAAI,IAAI,KAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAArC,CAAqC,CAAC,CAAC;gBACvE,CAAC;gBACD,QAAQ,EAAE,UAAC,KAAK,EAAE,QAAQ;oBACtB,QAAQ,CAAC,GAAG,CAAC,cAAI;wBACb,EAAE,CAAC,CAAC,CAAC,KAAI,CAAC,cAAc,CAAC,CAAC,CAAC;4BACvB,KAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,EAAE;gCACjB,GAAG,EAAE,IAAI,CAAC,KAAK;gCACf,IAAI,EAAE,IAAI,CAAC,IAAI;gCACf,MAAM,EAAE,WAAW;gCACnB,QAAQ,EAAE,CAAC;gCACX,GAAG,EAAE,KAAI,CAAC,QAAQ;6BACrB,CAAC,CAAC;4BACH,MAAM,CAAC;wBACX,CAAC;wBACD,EAAE,CAAC,CAAC,KAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,WAAC,IAAI,QAAC,CAAC,GAAG,KAAK,IAAI,CAAC,KAAK,EAApB,CAAoB,CAAC,CAAC,CAAC,CAAC;4BACjD,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;gCACf,GAAG,EAAE,IAAI,CAAC,KAAK;gCACf,IAAI,EAAE,IAAI,CAAC,IAAI;gCACf,MAAM,EAAE,WAAW;gCACnB,QAAQ,EAAE,CAAC;gCACX,GAAG,EAAE,KAAI,CAAC,QAAQ;6BACrB,CAAC,CAAC;wBACP,CAAC;wBAAC,IAAI,CAAC,CAAC;4BACJ,aAAa,CAAC,KAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,KAAK,EAAE,WAAC;gCACtC,CAAC,CAAC,MAAM,GAAG,WAAW,CAAC;gCACvB,CAAC,CAAC,QAAQ,GAAG,CAAC,CAAC;4BACnB,CAAC,CAAC,CAAC;wBACP,CAAC;oBACL,CAAC,CAAC,CAAC;oBACH,KAAI,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC;gBAC5B,CAAC;gBACD,UAAU,EAAE,UAAC,IAAI,EAAE,MAAM,EAAE,KAAK;oBAC5B,aAAa,CAAC,KAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,KAAK,EAAE,WAAC,IAAI,QAAC,CAAC,QAAQ,GAAG,CAAC,MAAM,GAAG,KAAK,GAAG,GAAG,CAAC,CAAC,OAAO,EAAE,EAA7C,CAA6C,CAAC,CAAC;gBACjG,CAAC;gBACD,SAAS,EAAE,UAAC,IAAI,EAAE,QAAQ;oBACtB,aAAa,CAAC,KAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,KAAK,EAAE,WAAC;wBACtC,CAAC,CAAC,MAAM,GAAG,MAAM,CAAC;wBAClB,CAAC,CAAC,QAAQ,GAAG,GAAG,CAAC;wBACjB,CAAC,CAAC,GAAG,GAAG,QAAQ,CAAC,GAAG,CAAC;oBACzB,CAAC,CAAC,CAAC;oBACH,EAAE,CAAC,CAAC,CAAC,KAAI,CAAC,cAAc,CAAC,CAAC,CAAC;wBACvB,KAAI,CAAC,KAAK,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;oBAChC,CAAC;oBAAC,IAAI,CAAC,CAAC;wBACJ,KAAI,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;oBAClC,CAAC;gBACL,CAAC;gBACD,SAAS,EAAE,UAAC,IAAI,EAAE,GAAG;oBACjB,aAAa,CAAC,KAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,KAAK,EAAE,WAAC;wBACtC,CAAC,CAAC,MAAM,GAAG,OAAO,CAAC;wBACnB,CAAC,CAAC,GAAG,GAAG,4BAA4B,CAAC;oBACzC,CAAC,CAAC;oBACF,MAAM,GAAG,CAAC;gBACd,CAAC;gBACD,UAAU,EAAE;oBACR,IAAI,KAAK,GAAG,KAAI,CAAC,KAAK,CAAC,MAAM,IAAI,KAAI,CAAC,KAAK,IAAI,CAAC,EAAE,CAAC,CAAC;oBACpD,KAAI,CAAC,YAAY,CAAC;wBACd,MAAM,EAAE,EAAE,KAAK,EAAE,KAAI,CAAC,cAAc,GAAG,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC,EAAE;wBACzD,IAAI,EAAE,aAAa;qBACtB,CAAC,CAAC;gBACP,CAAC;aACJ,CAAC,CAAC;QACP,CAAC;QACD,SAAS,YAAC,KAAK;QACf,CAAC;KACJ;CACJ,CAAC,CAAC;AAEH,uBAAuB,QAAQ,EAAE,GAAG,EAAE,QAAQ;IAC1C,QAAQ,CAAC,OAAO,CAAC,WAAC;QACd,EAAE,CAAC,CAAC,CAAC,CAAC,GAAG,KAAK,GAAG,CAAC,CAAC,CAAC;YAChB,QAAQ,CAAC,CAAC,CAAC,CAAC;YACZ,MAAM,CAAC,KAAK,CAAC;QACjB,CAAC;IACL,CAAC,CAAC,CAAC;AACP,CAAC","file":"ms-upload.js","sourcesContent":["import * as avalon from 'avalon2';\nimport controlComponent from '../ms-form/ms-control';\nimport { emitToFormItem } from '../ms-form/utils';\nimport './ms-upload.css';\nimport './ms-upload-list';\nimport './ms-upload-card';\nimport Uploader from 'up-loader';\n\n/**\n * 文件上传组件\n * @prop value 组件值(inherit)\n * @prop col 字段路径(inherit)\n * \n * @example\n * ``` html\n * <ms-upload :widget=\"{value:@record.attachment,col:'attachment',$rules:{required:true,type:'array'}}\">\n *      <i class=\"fa fa-upload\"></i>选择附件\n * </ms-upload>\n * ```\n */\ncontrolComponent.extend({\n    displayName: 'ms-upload',\n    template: __inline('./ms-upload.html'),\n    soleSlot: 'trigger',\n    defaults: {\n        helpId: '',\n        trigger: '',\n        value: [],\n        fileList: [],\n        action: '',\n        listType: 'text-list',\n        showUploadList: true,\n        btnClass: 'btn btn-default',\n        cardClass: 'bus-upload-select-card bus-upload-card-item',\n        blankImg: 'data:image/gif;base64,R0lGODlhAQABAIABAP///wAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==',\n        $uploader: null,\n        beforeUpload() {\n            return true;\n        },\n        handleRemove(file) {\n            let value;\n            this.fileList.removeAll(f => f.uid === file.uid);\n            this.value.remove(file.url);\n            value = this.value.$model || this.value || [''];\n            this.handleChange({\n                target: { value: this.showUploadList ? value : value[0] },\n                type: 'file-upload'\n            });\n        },\n        mapValueToFileList(value) {\n            value.map((url, i) => {\n                if (url === '') {\n                    return;\n                }\n                this.fileList.push({\n                    uid: -(i + 1),\n                    name: url.replace(/.*\\/([^\\/]+)\\/?/, '$1'),\n                    url: url,\n                    status: 'done',\n                    progress: 0\n                });\n            });\n        },\n        onInit(event) {\n            emitToFormItem(this);\n            this.helpId = this.$id;\n            this.mapValueToFileList(this.value);\n            this.$watch('value', v => {\n                let value = v.$model || v || [''];\n                this.fileList.clear();\n                this.mapValueToFileList(value);\n                this.handleChange({\n                    target: { value: this.showUploadList ? value : value[0] },\n                    denyValidate: true,\n                    type: 'file-upload'\n                });\n            });\n        },\n        onReady(event) {\n            this.$uploader = Uploader.init({\n                url: this.action,\n                fileInput: event.target.getElementsByTagName('input').file,\n                filter: (files) => {\n                    // 如果不支持图片信息的预览，则不进行过滤和限制\n                    return files.filter(file => !file.size || this.beforeUpload(file));\n                },\n                onSelect: (files, allFiles) => {\n                    allFiles.map(file => {\n                        if (!this.showUploadList) {\n                            this.fileList.set(0, {\n                                uid: file.index,\n                                name: file.name,\n                                status: 'uploading',\n                                progress: 0,\n                                url: this.blankImg\n                            });\n                            return;\n                        }\n                        if (this.fileList.every(f => f.uid !== file.index)) {\n                            this.fileList.push({\n                                uid: file.index,\n                                name: file.name,\n                                status: 'uploading',\n                                progress: 0,\n                                url: this.blankImg\n                            });\n                        } else {\n                            updateFileObj(this.fileList, file.index, f => {\n                                f.status = 'uploading';\n                                f.progress = 0;\n                            });\n                        }\n                    });\n                    this.$uploader.upload();\n                },\n                onProgress: (file, loaded, total) => {\n                    updateFileObj(this.fileList, file.index, f => f.progress = (loaded / total * 100).toFixed());\n                },\n                onSuccess: (file, response) => {\n                    updateFileObj(this.fileList, file.index, f => {\n                        f.status = 'done';\n                        f.progress = 100;\n                        f.url = response.url;\n                    });\n                    if (!this.showUploadList) {\n                        this.value = [response.url];\n                    } else {\n                        this.value.push(response.url);\n                    }\n                },\n                onFailure: (file, err) => {\n                    updateFileObj(this.fileList, file.index, f => {\n                        f.status = 'error';\n                        f.url = 'data:image/gif;base64,MA==';\n                    })\n                    throw err;\n                },\n                onComplete: () => {\n                    let value = this.value.$model || this.value || [''];\n                    this.handleChange({\n                        target: { value: this.showUploadList ? value : value[0] },\n                        type: 'file-upload'\n                    });\n                }\n            });\n        },\n        onDispose(event) {\n        }\n    }\n});\n\nfunction updateFileObj(fileList, uid, callback) {\n    fileList.forEach(f => {\n        if (f.uid === uid) {\n            callback(f);\n            return false;\n        }\n    });\n}"]}